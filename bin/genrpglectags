#!/usr/bin/env bash
# Usage:
#	genrpglectags <project>
#
# Author: Andreas Louv <andreas@louv.dk>

pgm=${0##*/}
version=0.4
usage='{ -h | -V | { -p project | -c } }'

project=""

shopt -s nullglob

while getopts "hVcp:" opt
do
	case $opt in
		h)
			cat << HELP
Usage $pgm $usage

  -c         Search CWD for project
  -p project Specify project

  -V         Show version information
  -h         Show this help and exit
HELP
			exit 0
			;;
		V)
			printf "%s %s\n" "$pgm" "$version"
			exit 0
			;;
		c)
			project=$(pwd |
			sed 's=^.*/\([^/]*\)/[^/]*/services.*=\1=p;d')
			;;
		p)
			project=$OPTARG
			;;
		:)

			>&2 printf '%s: expected argument for  option -%s\n' \
			           "$opt"
			exit 1
			;;
		\?)
			>&2 printf '%s: unknown option -%s\n' "$OPTARG"
			exit 1
			;;
	esac
done

if test -z "$project"
then
	>&2 printf "Usage '%s' %s\n" "$pgm" "$usage"
	exit 1
fi
gen_tags()
{
	dir=$1; shift
	file_globs="*.rpgle *.aspx *.asmx *.rpgleinc"
	cd "$dir"
	>&2 printf "Generating tags in '%s'\n" "$dir"

	if ! test -e tags
	then
		>&2 printf "Generate all tags\n" "$project"
		rpglectags $file_globs < /dev/null
	else
		tags_stat=$(stat -c %Y tags)
		modified=()
		>&2 printf "Partial generation, 'stat tags' = %d\n" \
			   "$tags_stat"
		for file in $file_globs
		do
			file_stat=$(stat -c %Y "$file")
			if test "$file_stat" -gt "$tags_stat"
			then
				modified+=("$file")
				>&2 printf "%s is modified\n" "$file"
			fi
		done

		tagstmp=$(mktemp)
		moditmp=$(mktemp)
		if test "${modified[0]}"
		then
			printf "%s\n" "${modified[@]}" > "$moditmp"
			awk -F'\t' \
			    'FILENAME != "tags" { modified[$0]++; next }
			     !modified[$2]' \
			     "$moditmp" tags > "$tagstmp"
			mv "$tagstmp" tags
			rm "$moditmp"

			rpglectags -a "${modified[@]}" < /dev/null
		fi
	fi
}

for dir in /mnt/dksrv206/www/Portfolio/Admin/Services		\
	   /mnt/dksrv206/www/dev/bas/shared/services		\
	   /mnt/dksrv206/www/dev/"$project"/customized/services
do
	gen_tags "$dir"
done
