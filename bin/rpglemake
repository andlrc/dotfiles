#!/bin/bash
# Usage rpglemake <file>
#
# Author: Andreas Louv <andreas@louv.dk>
# Version: 1.0

bnddir()
{
	local file=$1; shift

	grep -i 'ctl-opt' "$file" |
		grep -o \''[^'\'']\+'\' |
		grep -o '[^'\'']\+' |
		while IFS= read -r bnddir
		do
			if test -f "${bnddir,,}".srvpgm
			then
				echo "${bnddir,,}.bnddir"
			fi
		done
}

include()
{
	local file=$1; shift

	sed 's~^\s*/\(include\|copy\)\s\+\(.*\.rpgleinc\)\s*~\2~p;d' "$file"
}

for file
do
	if ! echo "$file" | grep -q '\.\(rpgle\)'
	then
		continue
	fi

	mapfile -t deps < <(include "$file")
	if test "${#deps[@]}" -gt 0
	then
		printf "%s.mod:\\t%s\\n" "${file%.*}" "${deps[*]}"
	fi

	if ! grep -i 'ctl-opt' "$file" | grep -qi nomain
	then
		mapfile -t deps < <(bnddir "$file")
		if test "${#deps[@]}" -gt 0
		then
			printf "%s.pgm:\\t%s\\n" "${file%.rpgle}" "${deps[*]}"
		fi
	fi

done
