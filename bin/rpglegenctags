#!/bin/sh
# Usage:	rpglegenctags { -h | -V | -[aw]... }
# Version:	0.9
# Author:	Andreas Louv <andreas@louv.dk>

pgm=${0##*/}
version=0.9
usage='{ -h | -V | -[aw]... }'

aflag=0
wflag=0

# print_help
print_help()
{
	cat << HELP
Usage $pgm $usage

  -a  generate tags for Portfolio and BAS
  -w  generate the whole tags file

  -V  show version information
  -h  show this help and exit
HELP
}

# in_list "needle" "item1" "item2" ... "itemN"
in_list()
{
	needle=$1; shift
	for item
	do
		if test "$item" = "$needle"
		then
			return 0
		fi
	done
	return 1
}

# gen_tags
gen_tags()
{
	file_globs="*.rpgle *.aspx *.asmx *.rpgleinc"
	if test "$wflag" -gt 0 || ! test -e tags
	then
		>&2 printf "Generating whole tags-file in '%s'\\n" "$dir"
		set -- # All files
		for file in $file_globs
		do
			test -e "$file" || continue
			set -- "$@" "$file"
		done
		rpglectags "$@" < /dev/null
	else
		tags_stat=$(stat -c %Y tags)
		mod_stat=0 # highest modified file change time
		mod_file='' # reference file
		files_tot=0
		files_mod=0
		for file in $file_globs
		do
			test -e "$file" || continue
			files_tot=$((files_tot+1))
		done
		for file in $file_globs
		do
			test -e "$file" || continue

			file_stat=$(stat -c %Y "$file")
			if test "$file_stat" -gt "$mod_stat"
			then
				mod_stat=$file_stat
				mod_file=$file
			fi
			files_mod=$((files_mod + 1))
			if test -t 2 # tty output
			then
				>&2 printf "\\r%*s" "$(tput cols)" " "
				>&2 printf "\\rChecking (%d/%d): %s"	\
				    "$files_mod" "$files_tot" "$dir/$file"
			else # log-file
				>&2 printf "Checking (%d/%d): %s\\n"	\
				    "$files_mod" "$files_tot" "$dir/$file"
			fi

			# Generate tags...
			if test "$file_stat" -gt "$tags_stat"
			then
				tagstmp=$(mktemp)
				awk -v file="$file" -F'\t' \
				     '$2 != file' tags > "$tagstmp"
				mv "$tagstmp" tags
				rpglectags -a "$file" < /dev/null
			fi
		done
		if test -t 2
		then
			>&2 printf "\\n"
		fi
		touch -mr "$mod_file" tags
	fi
}

while getopts "hVaw" opt
do
	case $opt in
		h)
			print_help
			exit 0
			;;
		V)
			printf "%s %s\\n" "$pgm" "$version"
			exit 0
			;;
		a)
			aflag=1
			;;
		w)
			wflag=1
			;;
		\?)
			>&2 printf '%s: unknown option -%s\n' \
				   "$pgm" "$OPTARG"
			exit 1
			;;
	esac
done

if test "$aflag" -gt 0
then
	set -- /mnt/dksrv206/www/Portfolio/Admin/Services	\
	       /mnt/dksrv206/www/dev/bas/shared/services
else
	set --
fi

if ! in_list "$PWD" "$@"
then
	set -- "$@" "$PWD"
fi

for dir
do
	( cd "$dir" && gen_tags )
done
