#!/bin/sh
# Usage:	rpglegenctags { -h | -V | -[avw]... }
# Author:	Andreas Louv <andreas@louv.dk>

pgm=${0##*/}
version=0.12
usage='{ -h | -V | -[aw]... }'

aflag=0
vflag=0
wflag=0

# print_help
print_help()
{
	cat << HELP
Usage $pgm $usage

  -a  generate tags for Portfolio and BAS
  -w  generate the whole tags file

  -V  show version information
  -h  show this help and exit
HELP
}

# in_list "needle" "item1" "item2" ... "itemN"
in_list()
{
	needle=$1; shift
	for item
	do
		if test "$item" = "$needle"
		then
			return 0
		fi
	done
	return 1
}

# print_file_info_tail "modified" "total" "dir"
print_file_info_tail()
{
	modified=$1; shift
	total=$1; shift

	if test -t 1 # tty output
	then
		printf "\\n"

		if test "$vflag" -ge 1
		then
			printf "Files modified %d out of %d in %s\\n"	\
			       "$modified" "$total" "$dir"
		fi
	elif test "$vflag" -ge 2
	then
		printf "!%d out of %d is modified in %s\\n"	\
		       "$modified" "$total" "$dir"
	fi
}

# print_file_info ix tot file
print_file_info()
{
	ix=$1; shift;
	tot=$1; shift;
	file=$1; shift;
	is_modified=$1; shift;

	if test -t 1 # tty output
	then
		# clear line
		printf "\\r%*s" "$(tput cols)" " "
		printf "\\rChecking (%d/%d): %s" "$ix" "$tot" "$file"
	else # log-file
		if test "$is_modified" -gt 0
		then
			printf "+%s\\n" "$file"
		elif test "$vflag" -ge 1
		then
			printf " %s\\n" "$file"
		fi
	fi
}

# gen_tags "directory"
gen_tags()
{
	dir=$1; shift
	(
		cd "$dir" || exit 1

		file_globs="*.rpgle *.aspx *.asmx *.rpgleinc"
		if test "$wflag" -gt 0 || ! test -e tags
		then
			printf "Generating whole tags-file in '%s'\\n" "$dir"
			set -- # All files
			for file in $file_globs
			do
				test -e "$file" || continue
				set -- "$@" "$file"
			done
			rpglectags "$@" < /dev/null
		else
			tags_stat=$(stat -c %Y tags)
			mod_stat=0 # highest modified file change time
			mod_file='' # reference file
			files_tot=0
			files_mod=0
			files_ix=0
			for file in $file_globs
			do
				test -e "$file" || continue
				files_tot=$((files_tot+1))
			done
			for file in $file_globs
			do
				test -e "$file" || continue

				file_stat=$(stat -c %Y "$file")
				if test "$file_stat" -gt "$mod_stat"
				then
					mod_stat=$file_stat
					mod_file=$file
				fi
				files_ix=$((files_ix + 1))
				if test "$file_stat" -gt "$tags_stat"
				then
					is_modified=1
				else
					is_modified=0
				fi

				print_file_info "$files_ix" "$files_tot"	\
						"$dir/$file" "$is_modified"

				# Generate tags...
				if test "$is_modified" -gt 0
				then
					tagstmp=$(mktemp)
					awk -v file="$file" -F'\t' \
					     '$2 != file' tags > "$tagstmp"
					mv "$tagstmp" tags
					rpglectags -a "$file" < /dev/null
					files_mod=$((files_mod + 1))
				fi
			done
			print_file_info_tail "$files_mod" "$files_tot" "$dir"
			touch -mr "$mod_file" tags
		fi
	)
}

while getopts "hVavw" opt
do
	case $opt in
		h)
			print_help
			exit 0
			;;
		V)
			printf "%s %s\\n" "$pgm" "$version"
			exit 0
			;;
		a)
			aflag=$((aflag + 1))
			;;
		v)
			vflag=$((vflag + 1))
			;;
		w)
			wflag=$((wflag + 1))
			;;
		\?)
			>&2 printf '%s: unknown option -%s\n' \
				   "$pgm" "$OPTARG"
			exit 1
			;;
	esac
done

if test "$aflag" -gt 0
then
	set -- /mnt/dksrv206/www/Portfolio/Admin/Services	\
	       /mnt/dksrv206/www/dev/bas/shared/services
else
	set --
fi

if ! in_list "$PWD" "$@"
then
	set -- "$@" "$PWD"
fi

for dir
do
	gen_tags "$dir"
done
