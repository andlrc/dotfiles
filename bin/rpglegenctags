#!/bin/sh
# Usage:	rpglegenctags { -h | -V | { -p project | -c } [ -g ] }
# Version:	0.7
# Author:	Andreas Louv <andreas@louv.dk>

pgm=${0##*/}
version=0.6
usage='{ -h | -V | -[aw]... }'

project=""
aflag=0
wflag=0

print_help()
{
	cat << HELP
Usage $pgm $usage

  -a  generate tags for Portfolio and BAS
  -w  generate the whole tags file

  -V  show version information
  -h  show this help and exit
HELP
}

gen_tags()
{
	file_globs="*.rpgle *.aspx *.asmx *.rpgleinc"
	if test "$wflag" -gt 0 || ! test -e tags
	then
		>&2 printf "Generating a new tag file in '%s'\\n" "$dir"
		set -- # All files
		for file in $file_globs
		do
			test -e "$file" || continue
			set -- "$@" "$file"
		done
		rpglectags "$@" < /dev/null
	else
		tags_stat=$(stat -c %Y tags)
		mod_stat=0 # highest modified file change time
		mod_file='' # reference file
		for file in $file_globs
		do
			test -e "$file" || continue
			file_stat=$(stat -c %Y "$file")
			if test "$file_stat" -ge "$tags_stat"
			then
				if test "$file_stat" -ge "$mod_stat"
				then
					mod_stat=$file_stat
					mod_file=$file
				fi
				>&2 printf "\\r%*s" "$(tput cols)" " "
				>&2 printf "\\rGenerating tags for '%s'"	\
				    "$dir/$file"
				tagstmp=$(mktemp)
				awk -v file="$file" -F'\t' \
				     '$2 != file' tags > "$tagstmp"
				mv "$tagstmp" tags
				rpglectags -a "$file" < /dev/null
			fi
		done
		if test "$mod_stat" -gt 0
		then
			>&2 printf "\\n"
			touch -mr "$mod_file" tags
		fi
	fi
}

while getopts "hVaw" opt
do
	case $opt in
		h)
			print_help
			exit 0
			;;
		V)
			printf "%s %s\\n" "$pgm" "$version"
			exit 0
			;;
		a)
			aflag=1
			;;
		w)
			wflag=1
			;;
		\?)
			>&2 printf '%s: unknown option -%s\n' \
				   "$pgm" "$OPTARG"
			exit 1
			;;
	esac
done

if test "$aflag" -gt 0
then
	set -- /mnt/dksrv206/www/Portfolio/Admin/Services	\
	       /mnt/dksrv206/www/dev/bas/shared/services
else
	set --
fi

project=$(pwd | sed 's=^/mnt/dksrv206/www/dev/\([^/]*\)/[^/]*/services.*=\1=p;d')
if test -n "$project"
then
	if ! test "$project" = "bas"
	then
		set -- "$@" /mnt/dksrv206/www/dev/"$project"/customized/services
	fi
else
	set -- "$@" .
fi

for dir
do
	( cd "$dir" && gen_tags )
done
