#!/bin/bash
# Author: Andreas Louv <andreas@louv.dk>
# Show combined git log of multiply repos for the last 24 hours.
# Repos are hardcoded but could easily come from arguments, same goes for the
# date.
#
# Usage:
#	whatdid
# Version: 1.1

shopt -s nullglob

author=$(git config --get user.name)
repos=()
[ "$EXT_ROOT" ] && repos+=("$EXT_ROOT/../"*"/")
[ "$SITEMULE_ROOT" ] && repos+=("$SITEMULE_ROOT/../"*"/")

for p_dir in "${repos[@]}"
do
  project=$(echo "$p_dir" | sed 's~.*/\([^/]*\)/$~\1~');
  (
    cd "$p_dir"
    git log --author="$author" --pretty='%ct %s' "${@:-"--since='1 day'"}"
    sed 's/^.*path = //p;d' .gitmodules 2> /dev/null | while read submodule
    do
      (
        cd "$submodule"
        git log --author="$author" --pretty='%ct %s' "${@:-"--since='1 day'"}"
      )
    done
  ) |
  sort -n | awk '{$1=" -"};1' | uniq -i -w 30 | 
  awk -v p="$project" 'NR == 1 { print toupper(p) };1'
done
